<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="1200">

  <style>
    .node { fill:#ffffff; stroke:#4b6cb7; stroke-width:1.4; rx:8; ry:8; }
    .diamond { fill:#ffffff; stroke:#444; stroke-width:1.4; }
    .title { font-size:18px; font-weight:bold; font-family:Arial, sans-serif; }
    .label { font-size:13px; font-family:Arial, sans-serif; }
    .small { font-size:11px; font-family:Arial, sans-serif; }
    .arrow { stroke:#444; stroke-width:1.5; marker-end:url(#arrowhead); }
    .edge-label { font-size:11px; font-family:Arial, sans-serif; fill:#333333; }
  </style>

  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#444444" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="60" y="40" class="title">SKAX Physical Risk LangGraph Workflow (graph.py v04)</text>

  <!-- Node 1: data_collection -->
  <rect x="410" y="60" width="280" height="70" class="node" />
  <text x="430" y="95" class="label">data_collection</text>
  <text x="430" y="117" class="small">데이터 수집</text>

  <!-- Edge: data_collection -> vulnerability_analysis -->
  <line x1="550" y1="130" x2="550" y2="160" class="arrow" />

  <!-- Node 2: vulnerability_analysis -->
  <rect x="410" y="160" width="280" height="70" class="node" />
  <text x="430" y="195" class="label">vulnerability_analysis</text>
  <text x="430" y="217" class="small">취약성 분석 및 리스크 선정</text>

  <!-- Edge: vulnerability_analysis -> branch (physical / aal) -->
  <line x1="550" y1="230" x2="550" y2="260" class="arrow" />

  <!-- Branch diamond (conceptual parallel) -->
  <polygon class="diamond" points="550,260 580,290 550,320 520,290" />
  <text x="590" y="294" class="small">병렬: physical_risk_score, aal_analysis</text>

  <!-- Edge: branch -> physical_risk_score -->
  <line x1="535" y1="315" x2="270" y2="340" class="arrow" />
  <text x="310" y="330" class="edge-label">to physical_risk_score</text>

  <!-- Edge: branch -> aal_analysis -->
  <line x1="565" y1="315" x2="830" y2="340" class="arrow" />
  <text x="700" y="330" class="edge-label">to aal_analysis</text>

  <!-- Node 3a: physical_risk_score (left) -->
  <rect x="160" y="340" width="260" height="70" class="node" />
  <text x="180" y="375" class="label">physical_risk_score</text>
  <text x="180" y="397" class="small">H x E x V 기반 점수 계산</text>

  <!-- Node 3b: aal_analysis (right) -->
  <rect x="680" y="340" width="260" height="70" class="node" />
  <text x="700" y="375" class="label">aal_analysis</text>
  <text x="700" y="397" class="small">AAL 분석 (P x D)</text>

  <!-- Edge: physical_risk_score -> risk_integration -->
  <line x1="290" y1="410" x2="290" y2="430" class="arrow" />
  <line x1="290" y1="430" x2="550" y2="460" class="arrow" />
  <text x="310" y="445" class="edge-label">물리 점수 결과</text>

  <!-- Edge: aal_analysis -> risk_integration -->
  <line x1="810" y1="410" x2="810" y2="430" class="arrow" />
  <line x1="810" y1="430" x2="550" y2="460" class="arrow" />
  <text x="720" y="445" class="edge-label">AAL 결과</text>

  <!-- Node 4: risk_integration -->
  <rect x="410" y="460" width="280" height="70" class="node" />
  <text x="430" y="495" class="label">risk_integration</text>
  <text x="430" y="517" class="small">물리 점수와 AAL 통합</text>

  <!-- Edge: risk_integration -> report_template -->
  <line x1="550" y1="530" x2="550" y2="560" class="arrow" />

  <!-- Node 5: report_template -->
  <rect x="410" y="560" width="280" height="70" class="node" />
  <text x="430" y="595" class="label">report_template</text>
  <text x="430" y="617" class="small">RAG 기반 리포트 템플릿 생성</text>

  <!-- Edge: report_template -> impact_analysis -->
  <line x1="550" y1="630" x2="550" y2="660" class="arrow" />

  <!-- Node 6: impact_analysis -->
  <rect x="410" y="660" width="280" height="70" class="node" />
  <text x="430" y="695" class="label">impact_analysis</text>
  <text x="430" y="717" class="small">전력 사용량 및 운영 영향 분석</text>

  <!-- Edge: impact_analysis -> strategy_generation -->
  <line x1="550" y1="730" x2="550" y2="760" class="arrow" />

  <!-- Node 7: strategy_generation -->
  <rect x="410" y="760" width="280" height="70" class="node" />
  <text x="430" y="795" class="label">strategy_generation</text>
  <text x="430" y="817" class="small">대응 전략 및 권고 사항 생성</text>

  <!-- Edge: strategy_generation -> report_generation -->
  <line x1="550" y1="830" x2="550" y2="860" class="arrow" />

  <!-- Node 8: report_generation -->
  <rect x="410" y="860" width="280" height="70" class="node" />
  <text x="430" y="895" class="label">report_generation</text>
  <text x="430" y="917" class="small">최종 리포트 초안 생성</text>

  <!-- Edge: report_generation -> validation -->
  <line x1="550" y1="930" x2="550" y2="960" class="arrow" />

  <!-- Node 9: validation (conditional branch) -->
  <polygon class="diamond" points="550,960 580,990 550,1020 520,990" />
  <text x="595" y="994" class="label">validation</text>
  <text x="595" y="1012" class="small">검증 및 이슈 분류</text>

  <!-- Node 10: refiner (left) -->
  <rect x="120" y="960" width="240" height="70" class="node" />
  <text x="140" y="995" class="label">refiner</text>
  <text x="140" y="1017" class="small">텍스트 및 구조 자동 보완</text>

  <!-- Node 11: finalization (bottom) -->
  <rect x="410" y="1080" width="280" height="70" class="node" />
  <text x="430" y="1115" class="label">finalization</text>
  <text x="430" y="1137" class="small">최종 결과 확정, END</text>

  <!-- Edge: validation -> refiner -->
  <line x1="530" y1="1015" x2="260" y2="1015" class="arrow" />
  <text x="300" y="1005" class="edge-label">조건: refiner 이슈</text>

  <!-- Edge: refiner -> validation (loop) -->
  <line x1="240" y1="960" x2="240" y2="930" class="arrow" />
  <line x1="240" y1="930" x2="520" y2="930" class="arrow" />
  <text x="260" y="922" class="edge-label">Refiner loop 최대 3회</text>

  <!-- Edge: validation -> impact_analysis (재실행) -->
  <line x1="565" y1="1015" x2="780" y2="1015" class="arrow" />
  <line x1="780" y1="1015" x2="780" y2="695" class="arrow" />
  <line x1="780" y1="695" x2="690" y2="695" class="arrow" />
  <text x="790" y="870" class="edge-label">조건: impact 관련 이슈</text>

  <!-- Edge: validation -> strategy_generation (재실행) -->
  <line x1="555" y1="1020" x2="820" y2="1050" class="arrow" />
  <line x1="820" y1="1050" x2="820" y2="795" class="arrow" />
  <line x1="820" y1="795" x2="690" y2="795" class="arrow" />
  <text x="830" y="960" class="edge-label">조건: strategy 관련 이슈</text>

  <!-- Edge: validation -> finalization (통과 또는 한계 초과) -->
  <line x1="550" y1="1020" x2="550" y2="1080" class="arrow" />
  <text x="560" y="1055" class="edge-label">조건: passed 또는 재시도 한계</text>

</svg>
