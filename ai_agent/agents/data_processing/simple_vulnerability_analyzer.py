"""
ê°„ë‹¨í•œ ê±´ë¬¼ ì·¨ì•½ì„± ë¶„ì„ê¸°
- API ì›ë³¸ ë°ì´í„°ì—ì„œ í•„ìˆ˜ í•­ëª©ë§Œ ì¶”ì¶œ
- LLMì—ê²Œ ì „ë‹¬í•˜ì—¬ 4~5ë¬¸ì¥ ì·¨ì•½ì„± ìš”ì•½ ìƒì„±
"""

import json
from typing import Dict, Any, Optional
from ...utils.llm_client import LLMClient


class SimpleVulnerabilityAnalyzer:
    """ë‹¨ìˆœí™”ëœ ì·¨ì•½ì„± ë¶„ì„ í´ë˜ìŠ¤"""
    
    def __init__(self):
        self.llm_client: LLMClient = LLMClient()
    
    def extract_essential_data(self, api_responses: Dict[str, Any]) -> Dict[str, Any]:
        """
        API ì›ë³¸ ì‘ë‹µì—ì„œ ì·¨ì•½ì„± ë¶„ì„ì— í•„ìš”í•œ í•„ìˆ˜ í•­ëª©ë§Œ ì¶”ì¶œ
        
        Args:
            api_responses: ê±´ì¶•ë¬¼ ëŒ€ì¥ API 5ê°œ ì—”ë“œí¬ì¸íŠ¸ ì›ë³¸ ì‘ë‹µ
        
        Returns:
            í•„ìˆ˜ ë°ì´í„°ë§Œ í¬í•¨ëœ ë”•ì…”ë„ˆë¦¬
        """

        
        # ë””ë²„ê¹…: API ì‘ë‹µ ìš”ì•½ ì¶œë ¥
        print("\n" + "="*80)
        print("  ğŸ“Š API ì‘ë‹µ ìš”ì•½")
        print("="*80)
        
        for endpoint_name, endpoint_data in api_responses.items():
            response_data = endpoint_data.get('response_data', {})
            body = response_data.get('response', {}).get('body', {})
            total_count = body.get('totalCount', 0)
            items = body.get('items', {}).get('item', [])
            actual_count = len(items) if isinstance(items, list) else (1 if items else 0)
            
            print(f"ğŸ“¡ {endpoint_name}: {actual_count}ê°œ ì•„ì´í…œ (ì „ì²´ {total_count}ê°œ)")
        
        print("="*80 + "\n")
        
        # API ì‘ë‹µì—ì„œ ì•„ì´í…œ ì¶”ì¶œ (PK ë§¤ì¹­ ì—†ì´ ì „ì²´ ì‚¬ìš©)
        basis_items = api_responses.get('getBrBasisOulnInfo', {}).get('response_data', {}).get('response', {}).get('body', {}).get('items', {}).get('item', [])
        title_items = api_responses.get('getBrTitleInfo', {}).get('response_data', {}).get('response', {}).get('body', {}).get('items', {}).get('item', [])
        recap_items = api_responses.get('getBrRecapTitleInfo', {}).get('response_data', {}).get('response', {}).get('body', {}).get('items', {}).get('item', [])
        floor_items = api_responses.get('getBrFlrOulnInfo', {}).get('response_data', {}).get('response', {}).get('body', {}).get('items', {}).get('item', [])
        
        # ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ë‹¨ì¼ ê°ì²´ì¸ ê²½ìš° ëŒ€ë¹„)
        basis_list = basis_items if isinstance(basis_items, list) else ([basis_items] if basis_items else [])
        title_list = title_items if isinstance(title_items, list) else ([title_items] if title_items else [])
        recap_list = recap_items if isinstance(recap_items, list) else ([recap_items] if recap_items else [])
        floors = floor_items if isinstance(floor_items, list) else ([floor_items] if floor_items else [])
        
        # ê° APIì˜ ì²« ë²ˆì§¸ ì•„ì´í…œ ì‚¬ìš© (ê°™ì€ bun/jië¡œ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ ê°™ì€ ê±´ë¬¼)
        basis = basis_list[0] if basis_list else {}
        
        # ğŸ” ì—¬ëŸ¬ ê±´ë¬¼ì˜ ì¢…í•© ì •ë³´ ì§‘ê³„
        # ê±´ë¬¼ë³„ ìš©ë„, êµ¬ì¡°, ë‚´ì§„ì„¤ê³„ ë“±ì€ title_list ì „ì²´ì—ì„œ ìˆ˜ì§‘
        all_structures = [t.get('strctCdNm', '') for t in title_list if t.get('strctCdNm')]
        all_purposes = [t.get('mainPurpsCdNm', '') for t in title_list if t.get('mainPurpsCdNm')]
        all_seismic = [t.get('rserthqkDsgnApplyYn') for t in title_list]
        all_use_dates = [t.get('useAprDay', '').strip() for t in title_list if t.get('useAprDay', '').strip()]
        
        # ì´ ì—°ë©´ì  (ëª¨ë“  ê±´ë¬¼ í•©ê³„)
        total_area = sum(float(t.get('totArea', 0) or 0) for t in title_list)
        
        # ì´ ì£¼ì°¨ëŒ€ìˆ˜, ì„¸ëŒ€ìˆ˜ (recapì—ì„œ)
        total_parking = sum(int(r.get('totPkngCnt', 0) or 0) for r in recap_list)
        total_households = sum(int(r.get('hhldCnt', 0) or 0) for r in recap_list)
        
        # ğŸ¢ ì¸µìˆ˜ ì§‘ê³„: getBrFlrOulnInfoì˜ ì‹¤ì œ ì¸µ ë°ì´í„°ë¡œ ê³„ì‚°
        ground_floors = [f for f in floors if f.get('flrGbCd') == '20']  # ì§€ìƒì¸µ
        underground_floors = [f for f in floors if f.get('flrGbCd') == '10']  # ì§€í•˜ì¸µ
        
        # ì¸µë³„ ìš©ë„ ì§‘ê³„ (ì¤‘ë³µ ì œê±°)
        all_floor_purposes = [f.get('mainPurpsCdNm', '') for f in floors if f.get('mainPurpsCdNm')]
        unique_floor_purposes = list(set(all_floor_purposes))
        
        # ì¸µìˆ˜ ë²”ìœ„ íŒŒì•… (ìµœê³ ì¸µ, ìµœì €ì¸µ)
        ground_floor_numbers = []  # ì§€ìƒì¸µ
        underground_floor_numbers = []  # ì§€í•˜ì¸µ
        
        for f in floors:
            floor_name = f.get('flrNoNm', '')
            floor_type = f.get('flrGbCd', '')
            # ìˆ«ìë§Œ ì¶”ì¶œ ì‹œë„
            import re
            match = re.search(r'\d+', floor_name)
            if match:
                num = int(match.group())
                if floor_type == '20':  # ì§€ìƒ
                    ground_floor_numbers.append(num)
                elif floor_type == '10':  # ì§€í•˜
                    underground_floor_numbers.append(-num)  # ìŒìˆ˜ë¡œ ë³€í™˜
        
        max_ground_floor = max(ground_floor_numbers) if ground_floor_numbers else 0
        min_underground_floor = min(underground_floor_numbers) if underground_floor_numbers else 0
        
        print(f"ğŸ¢ ì£¼ì†Œì§€ ê±´ë¬¼ ì¢…í•© ì •ë³´:")
        print(f"   ì£¼ì†Œ: {basis.get('platPlc', 'ë¯¸ìƒ')}")
        print(f"   ê±´ë¬¼ ìˆ˜: {len(title_list)}ê°œ")
        print(f"   ì´ ì—°ë©´ì : {total_area:,.0f}mÂ²")
        print(f"   ì§€ìƒì¸µ ë°ì´í„°: {len(ground_floors)}ê°œ (ìµœê³  {max_ground_floor}ì¸µ)")
        print(f"   ì§€í•˜ì¸µ ë°ì´í„°: {len(underground_floors)}ê°œ (ìµœì € ì§€í•˜{abs(min_underground_floor)}ì¸µ)")
        print(f"   ì „ì²´ ì¸µ ë°ì´í„°: {len(floors)}ê°œ")
        print(f"   ì¸µë³„ ìš©ë„ ì¢…ë¥˜: {len(unique_floor_purposes)}ê°œ - {', '.join(unique_floor_purposes[:5])}{'...' if len(unique_floor_purposes) > 5 else ''}")
        print("="*80 + "\n")
        
        # í•„ìˆ˜ ë°ì´í„° ì¶”ì¶œ
        essential_data = {
            # ê¸°ë³¸ ì •ë³´
            "ì£¼ì†Œ": basis.get('platPlc', 'ë¯¸ìƒ'),
            "ë„ë¡œëª…ì£¼ì†Œ": basis.get('newPlatPlc', 'ë¯¸ìƒ'),
            "ê±´ë¬¼_ìˆ˜": len(title_list),
            
            # êµ¬ì¡° ì •ë³´ (ì—¬ëŸ¬ ê±´ë¬¼ì˜ êµ¬ì¡° ì¢…ë¥˜)
            "ê±´ë¬¼êµ¬ì¡°_ì¢…ë¥˜": list(set(all_structures)),  # ì¤‘ë³µ ì œê±°
            "ì£¼ìš”ìš©ë„_ì¢…ë¥˜": list(set(all_purposes)),    # ì¤‘ë³µ ì œê±°
            
            # ê·œëª¨ (ì „ì²´ ê±´ë¬¼ ì§‘ê³„)
            "ì§€ìƒì¸µ_ì´ê°œìˆ˜": len(ground_floors),
            "ì§€í•˜ì¸µ_ì´ê°œìˆ˜": len(underground_floors),
            "ìµœê³ ì¸µìˆ˜": max_ground_floor,
            "ìµœì €ì§€í•˜ì¸µìˆ˜": abs(min_underground_floor),
            "ì´_ì—°ë©´ì _m2": round(total_area, 2),
            "ì¸µë³„_ìš©ë„_ì¢…ë¥˜": unique_floor_purposes,
            
            # ì—°ì‹ ë° ì•ˆì „ (ê°€ì¥ ì˜¤ë˜ëœ ê±´ë¬¼ ê¸°ì¤€)
            "ê°€ì¥_ì˜¤ë˜ëœ_ì‚¬ìš©ìŠ¹ì¸ì¼": min(all_use_dates) if all_use_dates else 'ë¯¸ìƒ',
            "ê°€ì¥_ìµœê·¼_ì‚¬ìš©ìŠ¹ì¸ì¼": max(all_use_dates) if all_use_dates else 'ë¯¸ìƒ',
            "ë‚´ì§„ì„¤ê³„_ì ìš©_ê±´ë¬¼ìˆ˜": sum(1 for s in all_seismic if s == '1'),
            "ë‚´ì§„ì„¤ê³„_ë¯¸ì ìš©_ê±´ë¬¼ìˆ˜": sum(1 for s in all_seismic if s != '1'),
            
            # ì¸µë³„ ìƒì„¸ (ì§€í•˜ì¸µ ìš°ì„  + ëŒ€í‘œ ì¸µë§Œ)
            "ì¸µë³„ì •ë³´_ìƒ˜í”Œ": [
                {
                    "ì¸µ": f.get('flrNoNm', ''),
                    "êµ¬ë¶„": "ì§€í•˜" if f.get('flrGbCd') == '10' else "ì§€ìƒ",
                    "ìš©ë„": f.get('mainPurpsCdNm', ''),
                    "ë©´ì _m2": float(f.get('area', 0) or 0)
                }
                # ì§€í•˜ì¸µ ë¨¼ì €, ê·¸ ë‹¤ìŒ ì§€ìƒì¸µ (ìµœëŒ€ 20ê°œ)
                for f in (underground_floors + ground_floors)[:20]
            ],
            
            # ì´ê´„ ì •ë³´
            "ì´ì£¼ì°¨ëŒ€ìˆ˜": total_parking,
            "ì´ì„¸ëŒ€ìˆ˜": total_households,
        }
        
        return essential_data
    
    def analyze_vulnerability(self, essential_data: Dict[str, Any]) -> str:
        """
        LLMì„ ì‚¬ìš©í•˜ì—¬ ê±´ë¬¼ ì·¨ì•½ì„± ìš”ì•½ ìƒì„± (4~5ë¬¸ì¥)
        
        Args:
            essential_data: ì¶”ì¶œëœ í•„ìˆ˜ ë°ì´í„°
        
        Returns:
            ì·¨ì•½ì„± ìš”ì•½ (4~5ë¬¸ì¥)
        """
        prompt = (
            "ë‹¤ìŒ ì£¼ì†Œì§€ì˜ ê±´ë¬¼ ì‹œì„¤ë¬¼ì— ëŒ€í•œ ë¬¼ë¦¬ì  ì·¨ì•½ì„±ì„ ë¶„ì„í•˜ì—¬ 4~5ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n\n"
            "# ì£¼ì†Œì§€ ê±´ë¬¼ ì •ë³´\n"
            "```json\n"
            f"{essential_data}\n"
            "```\n\n"
            "# ë¶„ì„ ì§€ì¹¨\n"
            "1. **ë…¸í›„ë„**: ê°€ì¥ ì˜¤ë˜ëœ/ìµœê·¼ ì‚¬ìš©ìŠ¹ì¸ì¼ ê¸°ì¤€ìœ¼ë¡œ ê±´ë¬¼êµ° ì—°ë ¹ í‰ê°€\n"
            "2. **êµ¬ì¡°ì  ì•ˆì „ì„±**: ë‚´ì§„ì„¤ê³„ ì ìš© ê±´ë¬¼ ë¹„ìœ¨, ë‹¤ì–‘í•œ êµ¬ì¡° ì¢…ë¥˜\n"
            "3. **ì¹¨ìˆ˜ ìœ„í—˜**: ì§€í•˜ì¸µ ê°œìˆ˜, ì§€í•˜ ìš©ë„ ë¶„ì„\n"
            "4. **í™”ì¬ ìœ„í—˜**: ì¸µìˆ˜ ë¶„í¬, ê±´ë¬¼ êµ¬ì¡°ì¬, ìš©ë„ ê³ ë ¤\n"
            "5. **ê¸°íƒ€ ë¦¬ìŠ¤í¬**: ê±´ë¬¼ ìˆ˜, ì´ ì—°ë©´ì , íŠ¹ì´ì‚¬í•­\n\n"
            "# ì¶œë ¥ í˜•ì‹\n"
            "- 4~5ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ\n"
            "- êµ¬ì²´ì ì¸ ìˆ«ìì™€ ê·¼ê±° í¬í•¨ (ì˜ˆ: \"80ê°œ ê±´ë¬¼ ì¤‘ ë‚´ì§„ì„¤ê³„ ë¯¸ì ìš© ê±´ë¬¼ 75ê°œ\")\n"
            "- ê°€ì¥ ì¤‘ìš”í•œ ì·¨ì•½ì  ìš°ì„  ì„œìˆ \n"
            "- ì „ë¬¸ì ì´ê³  ê°ê´€ì ì¸ í†¤\n\n"
            "ì·¨ì•½ì„± ìš”ì•½:"
        )

        try:
            response = self.llm_client.invoke(
                prompt=prompt,
                temperature=0.3,  # ë‚®ì€ ì˜¨ë„ë¡œ ì¼ê´€ì„± ìˆëŠ” ì‘ë‹µ
                max_tokens=500
            )
            return response.strip()
        except Exception as e:
            return f"ì·¨ì•½ì„± ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"
    
    def run_analysis(self, api_responses: Dict[str, Any]) -> Dict[str, Any]:
        """
        ì „ì²´ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
        
        Args:
            api_responses: API ì›ë³¸ ì‘ë‹µ
        
        Returns:
            {
                "essential_data": {...},
                "vulnerability_summary": "..."
            }
        """
        # 1. í•„ìˆ˜ ë°ì´í„° ì¶”ì¶œ
        essential_data = self.extract_essential_data(api_responses)
        
        # 2. LLM ì·¨ì•½ì„± ë¶„ì„
        vulnerability_summary = self.analyze_vulnerability(essential_data)
        
        return {
            "essential_data": essential_data,
            "vulnerability_summary": vulnerability_summary
        }
