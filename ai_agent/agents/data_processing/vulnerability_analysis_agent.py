'''
파일명: vulnerability_analysis_agent.py
최종 수정일: 2025-11-11
버전: v00
파일 개요: 건물 및 시설 취약성 분석 Agent (건물 연식, 내진 설계 여부, 소방차 진입 가능성 분석)
'''
from typing import Dict, Any
import logging


logger = logging.getLogger(__name__)


class VulnerabilityAnalysisAgent:
	"""
	취약성 분석 Agent
	건물 정보를 기반으로 기후 리스크에 대한 취약성을 정량화
	"""

	def __init__(self):
		"""
		VulnerabilityAnalysisAgent 초기화
		"""
		self.logger = logger
		self.logger.info("VulnerabilityAnalysisAgent 초기화 완료")

	def analyze_vulnerability(self, building_info: Dict[str, Any], target_location: Dict[str, Any]) -> Dict[str, Any]:
		"""
		건물 취약성 종합 분석 수행
		건물 연식, 내진 설계, 소방차 진입 가능성 등을 분석

		Args:
			building_info: 건물 정보 딕셔너리
				- building_age: 건물 연식 (년)
				- seismic_design: 내진 설계 여부 (bool)
				- structure_type: 건물 구조 (예: RC, Steel, Wood)
				- floors: 층수
				- usage_type: 건물 용도 (예: Office, Residential, Industrial)
			target_location: 위치 정보 딕셔너리
				- latitude: 위도
				- longitude: 경도
				- address: 주소
				- road_width: 도로 폭 (m)

		Returns:
			취약성 분석 결과 딕셔너리
				- building_age_score: 건물 연식 취약성 점수 (0.0 ~ 1.0)
				- seismic_vulnerability_score: 내진 설계 취약성 점수 (0.0 ~ 1.0)
				- fire_access_score: 소방차 진입 가능성 점수 (0.0 ~ 1.0)
				- overall_vulnerability_score: 종합 취약성 점수 (0.0 ~ 1.0)
				- vulnerability_details: 상세 분석 내역
		"""
		self.logger.info(f"취약성 분석 시작: {building_info.get('usage_type', 'Unknown')} 건물")

		try:
			# 1. 건물 연식 취약성 분석
			building_age_score = self._analyze_building_age(building_info.get('building_age', 0))

			# 2. 내진 설계 취약성 분석
			seismic_vulnerability_score = self._analyze_seismic_design(
				building_info.get('seismic_design', False),
				building_info.get('structure_type', 'RC'),
				building_info.get('floors', 1)
			)

			# 3. 소방차 진입 가능성 분석
			fire_access_score = self._analyze_fire_access(
				target_location.get('road_width', 6.0),
				building_info.get('floors', 1)
			)

			# 4. 종합 취약성 점수 계산 (가중 평균)
			overall_vulnerability_score = (
				building_age_score * 0.35 +
				seismic_vulnerability_score * 0.40 +
				fire_access_score * 0.25
			)

			vulnerability_result = {
				'building_age_score': round(building_age_score, 3),
				'seismic_vulnerability_score': round(seismic_vulnerability_score, 3),
				'fire_access_score': round(fire_access_score, 3),
				'overall_vulnerability_score': round(overall_vulnerability_score, 3),
				'vulnerability_details': {
					'building_age_analysis': self._get_building_age_description(building_info.get('building_age', 0)),
					'seismic_analysis': self._get_seismic_description(building_info.get('seismic_design', False)),
					'fire_access_analysis': self._get_fire_access_description(target_location.get('road_width', 6.0))
				},
				'status': 'completed'
			}

			self.logger.info(f"취약성 분석 완료: 종합 점수 {overall_vulnerability_score:.3f}")
			return vulnerability_result

		except Exception as e:
			self.logger.error(f"취약성 분석 중 오류 발생: {str(e)}", exc_info=True)
			return {
				'status': 'failed',
				'error': str(e)
			}

	def _analyze_building_age(self, building_age: int) -> float:
		"""
		건물 연식 기반 취약성 점수 계산
		오래된 건물일수록 취약성이 높음

		Args:
			building_age: 건물 연식 (년)

		Returns:
			취약성 점수 (0.0 ~ 1.0)
		"""
		if building_age < 10:  # 신축 건물
			return 0.2
		if building_age < 20:  # 10~20년
			return 0.4
		if building_age < 30:  # 20~30년
			return 0.6
		if building_age < 40:  # 30~40년
			return 0.8
		# 40년 이상 노후 건물
		return 1.0

	def _analyze_seismic_design(self, seismic_design: bool, structure_type: str, floors: int) -> float:
		"""
		내진 설계 여부 기반 취약성 점수 계산
		내진 설계가 없고 층수가 높을수록 취약성 증가

		Args:
			seismic_design: 내진 설계 여부
			structure_type: 건물 구조 (RC, Steel, Wood)
			floors: 층수

		Returns:
			취약성 점수 (0.0 ~ 1.0)
		"""
		base_score = 0.3 if seismic_design else 0.7  # 내진 설계 유무 기본 점수

		# 건물 구조에 따른 조정
		structure_factors = {
			'Steel': 0.8,  # 철골 구조: 비교적 안전
			'RC': 1.0,  # 철근 콘크리트: 보통
			'Wood': 1.3  # 목조: 취약
		}
		structure_factor = structure_factors.get(structure_type, 1.0)

		# 층수에 따른 조정 (고층 건물일수록 지진 영향 증가)
		floor_factor = min(1.0 + (floors - 1) * 0.02, 1.5)  # 최대 1.5배

		final_score = base_score * structure_factor * floor_factor
		return min(final_score, 1.0)  # 최대값 1.0 제한

	def _analyze_fire_access(self, road_width: float, floors: int) -> float:
		"""
		소방차 진입 가능성 점수 계산
		도로 폭이 좁을수록, 건물이 높을수록 소방 대응 어려움

		Args:
			road_width: 도로 폭 (m)
			floors: 건물 층수

		Returns:
			취약성 점수 (0.0 ~ 1.0)
		"""
		# 도로 폭 기준 (소방차 진입 기준: 최소 6m)
		if road_width >= 8.0:  # 여유 있는 진입로
			road_score = 0.2
		elif road_width >= 6.0:  # 최소 기준 충족
			road_score = 0.5
		elif road_width >= 4.0:  # 진입 어려움
			road_score = 0.8
		else:  # 진입 불가
			road_score = 1.0

		# 층수에 따른 추가 점수 (고층일수록 소방 대응 어려움)
		if floors <= 5:  # 저층
			floor_adjustment = 1.0
		elif floors <= 10:  # 중층
			floor_adjustment = 1.2
		else:  # 고층
			floor_adjustment = 1.5

		final_score = road_score * floor_adjustment
		return min(final_score, 1.0)  # 최대값 1.0 제한

	def _get_building_age_description(self, building_age: int) -> str:
		"""
		건물 연식 분석 결과 텍스트 생성

		Args:
			building_age: 건물 연식 (년)

		Returns:
			분석 결과 설명 문자열
		"""
		if building_age < 10:
			return f"신축 건물 ({building_age}년): 구조적 안정성 우수"
		if building_age < 20:
			return f"비교적 최근 건물 ({building_age}년): 양호한 상태"
		if building_age < 30:
			return f"중간 연식 건물 ({building_age}년): 일부 노후화 진행"
		if building_age < 40:
			return f"노후 건물 ({building_age}년): 보강 필요 검토"
		return f"고령 건물 ({building_age}년): 구조 안전 진단 필수"

	def _get_seismic_description(self, seismic_design: bool) -> str:
		"""
		내진 설계 분석 결과 텍스트 생성

		Args:
			seismic_design: 내진 설계 여부

		Returns:
			분석 결과 설명 문자열
		"""
		if seismic_design:
			return "내진 설계 적용: 지진 대응 능력 확보"
		return "내진 설계 미적용: 지진 발생 시 구조적 위험 존재"

	def _get_fire_access_description(self, road_width: float) -> str:
		"""
		소방차 진입 가능성 분석 결과 텍스트 생성

		Args:
			road_width: 도로 폭 (m)

		Returns:
			분석 결과 설명 문자열
		"""
		if road_width >= 8.0:
			return f"도로 폭 {road_width}m: 소방차 진입 및 활동 공간 충분"
		if road_width >= 6.0:
			return f"도로 폭 {road_width}m: 소방차 진입 가능 (최소 기준 충족)"
		if road_width >= 4.0:
			return f"도로 폭 {road_width}m: 소방차 진입 제한적 (대응 지연 우려)"
		return f"도로 폭 {road_width}m: 소방차 진입 불가 (비상 대응 어려움)"
