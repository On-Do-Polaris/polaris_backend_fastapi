#!/usr/bin/env python3
"""
ì·¨ì•½ì„± ë¶„ì„ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸
ì‘ì„±ì¼: 2025-12-10

í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:
1. BuildingDataFetcher - ê±´ì¶•ë¬¼ ë°ì´í„° ìˆ˜ì§‘ (fetch_full_tcfd_data)
2. VulnerabilityAnalysisAgent - ì·¨ì•½ì„± ë¶„ì„ ë° LLM ë¦¬í¬íŠ¸ ìƒì„±
"""

import sys
import json
from pathlib import Path
from datetime import datetime

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ sys.pathì— ì¶”ê°€
BASE_DIR = Path(__file__).parent
sys.path.insert(0, str(BASE_DIR))

from ai_agent.utils.building_data_fetcher import BuildingDataFetcher
from ai_agent.agents.data_processing.vulnerability_analysis_agent import VulnerabilityAnalysisAgent
from ai_agent.utils.llm_client import LLMClient

# í…ŒìŠ¤íŠ¸ ì£¼ì†Œ
TEST_ADDRESS = "ëŒ€ì „ê´‘ì—­ì‹œ ìœ ì„±êµ¬ ì—‘ìŠ¤í¬ë¡œ 325"  # SK ëŒ€ë• R&D (140-1ë²ˆì§€, 80ê°œ ê±´ë¬¼)


def print_separator(char="=", length=80):
    """êµ¬ë¶„ì„  ì¶œë ¥"""
    print(char * length)


def print_section(title):
    """ì„¹ì…˜ ì œëª© ì¶œë ¥"""
    print(f"\n")
    print_separator()
    print(f"  {title}")
    print_separator()


def save_json(data, filename):
    """JSON íŒŒì¼ ì €ì¥"""
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print(f"   ğŸ’¾ ì €ì¥: {filename}")


def test_building_data_fetcher():
    """Step 1: BuildingDataFetcher í…ŒìŠ¤íŠ¸"""
    print_section("Step 1: BuildingDataFetcher - TCFD ë°ì´í„° ìˆ˜ì§‘")
    
    try:
        fetcher = BuildingDataFetcher()
        print("âœ… BuildingDataFetcher ì´ˆê¸°í™” ì„±ê³µ\n")
        
        # ì£¼ì†Œë¡œ TCFD ë°ì´í„° ì¡°íšŒ
        print(f"ğŸ“ í…ŒìŠ¤íŠ¸ ì£¼ì†Œ: {TEST_ADDRESS}")
        print(f"ğŸ” TCFD ë°ì´í„° ìˆ˜ì§‘ ì¤‘...\n")
        
        tcfd_data = fetcher.fetch_full_tcfd_data(
            lat=36.3723,
            lon=127.3844,
            address=TEST_ADDRESS
        )
        
        if not tcfd_data:
            print("âŒ TCFD ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨")
            return None
        
        print("âœ… TCFD ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ\n")
        
        # ë°ì´í„° êµ¬ì¡° í™•ì¸
        print("ğŸ“‹ ë°ì´í„° êµ¬ì¡°:")
        for key in ['meta', 'physical_specs', 'transition_specs', 'floor_details', 'geo_risks']:
            if key in tcfd_data:
                value = tcfd_data[key]
                if isinstance(value, list):
                    print(f"   âœ… {key}: {len(value)}ê°œ í•­ëª©")
                elif isinstance(value, dict):
                    print(f"   âœ… {key}: {len(value)}ê°œ í•„ë“œ")
                else:
                    print(f"   âœ… {key}: {type(value).__name__}")
            else:
                print(f"   âŒ {key}: ì—†ìŒ")
        
        # ì£¼ìš” ë°ì´í„° ì¶œë ¥
        print("\nğŸ“Š ì£¼ìš” ë°ì´í„°:")
        meta = tcfd_data.get('meta', {})
        physical = tcfd_data.get('physical_specs', {})
        
        print(f"\n[ë©”íƒ€ ì •ë³´]")
        print(f"  - ì£¼ì†Œ: {meta.get('address', 'N/A')}")
        print(f"  - ê±´ë¬¼ ìˆ˜: {meta.get('building_count', 0)}ê°œ")
        
        print(f"\n[ë¬¼ë¦¬ì  íŠ¹ì„±]")
        if 'age' in physical:
            print(f"  - ì¤€ê³µì—°ë„: {physical['age'].get('completion_year', 'N/A')}")
            print(f"  - ê±´ë¬¼ ì—°ë ¹: {physical['age'].get('years', 'N/A')}ë…„")
        
        if 'seismic' in physical:
            seismic = physical['seismic']
            print(f"  - ë‚´ì§„ì„¤ê³„ ì ìš©: {seismic.get('buildings_with_design', 0)}ê°œ")
            print(f"  - ë‚´ì§„ì„¤ê³„ ë¯¸ì ìš©: {seismic.get('buildings_without_design', 0)}ê°œ")
        
        if 'structure_types' in physical:
            print(f"  - êµ¬ì¡° ì¢…ë¥˜: {', '.join(physical['structure_types'])}")
        
        if 'floors' in physical:
            floors = physical['floors']
            print(f"  - ìµœëŒ€ ì§€ìƒì¸µ: {floors.get('max_ground', 0)}ì¸µ")
            print(f"  - ìµœì € ì§€í•˜ì¸µ: {floors.get('min_underground', 0)}ì¸µ")
        
        # JSON íŒŒì¼ ì €ì¥
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"tcfd_data_{timestamp}.json"
        save_json(tcfd_data, filename)
        
        return tcfd_data
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return None


def test_vulnerability_analysis_agent(tcfd_data):
    """Step 2: VulnerabilityAnalysisAgent í…ŒìŠ¤íŠ¸"""
    print_section("Step 2: VulnerabilityAnalysisAgent - ì·¨ì•½ì„± ë¶„ì„")
    
    if not tcfd_data:
        print("âŒ TCFD ë°ì´í„°ê°€ ì—†ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.")
        return
    
    try:
        # LLM í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        print("ğŸ¤– LLM í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...")
        llm_client = LLMClient()
        print("âœ… LLM í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ\n")
        
        # VulnerabilityAnalysisAgent ì´ˆê¸°í™”
        print("ğŸ”§ VulnerabilityAnalysisAgent ì´ˆê¸°í™” ì¤‘...")
        agent = VulnerabilityAnalysisAgent(llm_client=llm_client)
        print("âœ… VulnerabilityAnalysisAgent ì´ˆê¸°í™” ì„±ê³µ\n")
        
        # ì·¨ì•½ì„± ë¶„ì„ ì‹¤í–‰
        print("ğŸ” ì·¨ì•½ì„± ë¶„ì„ ì‹¤í–‰ ì¤‘...\n")
        result = agent.analyze(
            lat=36.3723,
            lon=127.3844,
            address=TEST_ADDRESS
        )
        
        if not result:
            print("âŒ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        print("âœ… ë¶„ì„ ì™„ë£Œ\n")
        
        # ê²°ê³¼ ì¶œë ¥
        print_separator("-")
        print("ğŸ“Š ë¶„ì„ ê²°ê³¼:")
        print_separator("-")
        
        print(f"\nì¢…í•© ë“±ê¸‰: {result.get('structural_grade', 'N/A')}")
        
        vulnerabilities = result.get('vulnerabilities', [])
        print(f"\nì·¨ì•½ì„± ìš”ì¸: {len(vulnerabilities)}ê°œ")
        for v in vulnerabilities[:5]:  # ìƒìœ„ 5ê°œ
            print(f"  - [{v.get('category')}] {v.get('factor')} ({v.get('severity')})")
        
        resilience = result.get('resilience', [])
        print(f"\níšŒë³µë ¥ ìš”ì¸: {len(resilience)}ê°œ")
        for r in resilience[:5]:  # ìƒìœ„ 5ê°œ
            print(f"  - [{r.get('category')}] {r.get('factor')} ({r.get('strength')})")
        
        # LLM ë¦¬í¬íŠ¸
        llm_report = result.get('analysis_report', '')
        print(f"\nğŸ“ LLM ë¶„ì„ ë¦¬í¬íŠ¸:")
        print_separator("-")
        if llm_report:
            # ì²˜ìŒ 500ìë§Œ ì¶œë ¥
            preview = llm_report[:500]
            print(preview)
            if len(llm_report) > 500:
                print(f"\n... (ì „ì²´ {len(llm_report)}ì, ë‚˜ë¨¸ì§€ëŠ” íŒŒì¼ ì°¸ì¡°)")
        else:
            print("âŒ LLM ë¦¬í¬íŠ¸ ì—†ìŒ")
        
        # ê²°ê³¼ ì €ì¥
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # JSON ì €ì¥
        json_filename = f"vulnerability_analysis_{timestamp}.json"
        save_json(result, json_filename)
        
        # ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ ì €ì¥
        if llm_report:
            md_filename = f"vulnerability_report_{timestamp}.md"
            with open(md_filename, 'w', encoding='utf-8') as f:
                f.write(f"# ì·¨ì•½ì„± ë¶„ì„ ë¦¬í¬íŠ¸\n\n")
                f.write(f"**ë¶„ì„ ì¼ì‹œ**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"**ëŒ€ìƒ ì£¼ì†Œ**: {TEST_ADDRESS}\n\n")
                f.write(f"---\n\n")
                f.write(llm_report)
            print(f"   ğŸ’¾ ì €ì¥: {md_filename}")
        
        print_separator("-")
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()


def main():
    """ë©”ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""
    print_separator("=")
    print("  ì·¨ì•½ì„± ë¶„ì„ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸")
    print_separator("=")
    print(f"\ní…ŒìŠ¤íŠ¸ ì‹œì‘: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    
    # Step 1: ë°ì´í„° ìˆ˜ì§‘
    tcfd_data = test_building_data_fetcher()
    
    # Step 2: ì·¨ì•½ì„± ë¶„ì„
    if tcfd_data:
        test_vulnerability_analysis_agent(tcfd_data)
    
    print_section("í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
    print(f"ì™„ë£Œ ì‹œê°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")


if __name__ == "__main__":
    main()
