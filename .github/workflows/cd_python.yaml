name: CD - Deploy

on:
  workflow_run:
    workflows: ["CI - Test & Build"]
    types: [completed]
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: polaris-backend-fastapi

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: 서버에 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # 최신 코드 가져오기
            git pull origin main

            # 스크립트 실행 권한 부여
            chmod +x ./docker-deploy.sh

            # 환경변수 설정
            export REGISTRY=${{ env.REGISTRY }}
            export REGISTRY_USERNAME=${{ github.actor }}
            export REGISTRY_PASSWORD=${{ secrets.GITHUB_TOKEN }}
            export GITHUB_REPOSITORY=${{ github.repository }}
            export IMAGE_TAG=${{ github.event.workflow_run.head_sha }}

            # 배포 실행
            ./docker-deploy.sh deploy

            echo "✅ Deployment completed!"

      - name: 배포 완료 알림
        if: success()
        run: |
          echo "✅ Deployment to server completed successfully!"
          echo "Server: ${{ secrets.SERVER_HOST }}"

      - name: 배포 실패 알림
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          exit 1
