graph TB
    subgraph Input
        START([ğŸ”µ ì‹œì‘<br/>site_ids: List int<br/>excel_file: str optional<br/>user_id: int])
    end

    subgraph "Phase 1: Data Collection"
        N0["<b>Node 0: Data Loading</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ DB ì§ì ‘ ì¿¼ë¦¬ 8 ì‚¬ì—…ì¥<br/>â–¸ Building Characteristics Agent<br/>â–¸ Additional Data Agent ì¡°ê±´ë¶€<br/><br/>ğŸ“¤ sites_data, building_guidelines, excel_guidelines"]

        N1["<b>Node 1: Template Loading</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ RAG ì—”ì§„<br/>â–¸ TCFD êµ¬ì¡° ë¡œë”©<br/>â–¸ ìŠ¤íƒ€ì¼ ì°¸ì¡°<br/><br/>ğŸ“¤ tcfd_structure, style_references, citations"]
    end

    subgraph "Phase 2: Analysis Layer"
        N2A["<b>Node 2-A: Scenario Analysis</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ 4ê°œ ì‹œë‚˜ë¦¬ì˜¤ AAL ê³„ì‚°<br/>â–¸ 8ê°œ ì‚¬ì—…ì¥ ë³‘ë ¬ ì²˜ë¦¬<br/><br/>ğŸ“Š TableBlock ìƒì„±<br/>ì‹œë‚˜ë¦¬ì˜¤ë³„ AAL ë¹„êµí‘œ<br/><br/>ğŸ“¤ scenarios, scenario_table"]

        N2B["<b>Node 2-B: Impact Analysis</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ Top 5 ë¦¬ìŠ¤í¬ ì˜í–¥ ë¶„ì„<br/>â–¸ 5ê°œ ë¦¬ìŠ¤í¬ ë³‘ë ¬ ì²˜ë¦¬<br/><br/>ğŸ“ TextBlock ìƒì„± 5ê°œ<br/>P1~P5 ì˜í–¥ ë¶„ì„<br/><br/>ğŸ“¤ top_5_risks, impact_blocks"]

        N2C["<b>Node 2-C: Mitigation Strategies</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ Top 5 ë¦¬ìŠ¤í¬ ëŒ€ì‘ ë°©ì•ˆ<br/>â–¸ 5ê°œ ë¦¬ìŠ¤í¬ ë³‘ë ¬ ì²˜ë¦¬<br/><br/>ğŸ“ TextBlock ìƒì„± 5ê°œ<br/>P1~P5 ëŒ€ì‘ ì „ëµ<br/><br/>ğŸ“¤ mitigation_strategies, mitigation_blocks"]
    end

    subgraph "Phase 3: Formatting Layer"
        N3["<b>Node 3: Strategy Section</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ Node 2-A/B/C ê²°ê³¼ ì¡°ë¦½<br/>â–¸ Executive Summary ìƒì„±<br/><br/>ğŸ”¥ HeatmapTableBlock ìƒì„±<br/>ì‚¬ì—…ì¥ë³„ ë¦¬ìŠ¤í¬ AAL ë¶„í¬<br/><br/>ğŸ“¤ strategy_section Section"]
    end

    subgraph "Phase 4: Validation & Composition"
        N4["<b>Node 4: Validator</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ TCFD 7ëŒ€ ì›ì¹™ ê²€ì¦<br/>â–¸ ëˆ„ë½ ì„¹ì…˜ ì²´í¬<br/>â–¸ 1íšŒ ì¬ìƒì„± í•„ìš”ì‹œ<br/><br/>ğŸ“¤ validated_sections, validation_result"]

        N5["<b>Node 5: Composer</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ Risk Management í…œí”Œë¦¿<br/>â–¸ Governance í•˜ë“œì½”ë”©<br/>â–¸ Appendix í•˜ë“œì½”ë”©<br/>â–¸ Metrics & Targets<br/><br/>ğŸ“ˆ LineChartBlock ìƒì„±<br/>AAL ì¶”ì´ ì°¨íŠ¸ 2024-2100<br/><br/>â–¸ ëª©ì°¨ ìƒì„±<br/>â–¸ ì „ì²´ ì¡°ë¦½<br/><br/>ğŸ“¤ report TCFDReport"]
    end

    subgraph "Phase 5: Finalization"
        N6["<b>Node 6: Finalizer</b><br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â–¸ JSONB DB ì €ì¥<br/>â–¸ ì‚¬ì—…ì¥-ë³´ê³ ì„œ ê´€ê³„ ì €ì¥<br/><br/>ğŸ“¤ success, report_id, download_url"]
    end

    subgraph Output
        END([ğŸŸ¢ ì™„ë£Œ<br/>report_id: int<br/>download_url: str])
    end

    START --> N0
    N0 --> N1
    N1 --> N2A
    N2A --> N2B
    N2B --> N2C
    N2C --> N3
    N3 --> N4
    N4 --> N5
    N5 --> N6
    N6 --> END

    style START fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style END fill:#2196F3,stroke:#1565C0,stroke-width:3px,color:#fff

    style N0 fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style N1 fill:#FFF3E0,stroke:#F57C00,stroke-width:2px

    style N2A fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style N2B fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style N2C fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px

    style N3 fill:#E8F5E9,stroke:#388E3C,stroke-width:2px

    style N4 fill:#FFF9C4,stroke:#F9A825,stroke-width:2px
    style N5 fill:#FFEBEE,stroke:#C62828,stroke-width:2px

    style N6 fill:#FCE4EC,stroke:#AD1457,stroke-width:2px
