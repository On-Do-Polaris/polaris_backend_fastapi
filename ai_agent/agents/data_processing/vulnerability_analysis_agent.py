'''
파일명: vulnerability_analysis_agent.py
최종 수정일: 2025-11-24
버전: v01
파일 개요: 9개 물리적 리스크별 취약성 분석 Agent
변경 이력:
	- 2025-11-11: v00 - 초기 버전 (기본 취약성 분석)
	- 2025-11-24: v01 - Physical_RISK_calculate 로직 통합 (9개 리스크별 상세 계산)

Based on: Physical_RISK_calculate/code/vulnerability_calculator.py
'''
from typing import Dict, Any
import logging


logger = logging.getLogger(__name__)


class VulnerabilityAnalysisAgent:
	"""
	취약성(Vulnerability) 분석 Agent

	건물 정보를 기반으로 9개 물리적 리스크에 대한 취약성을 정량화

	취약성 정의:
	- 건물의 구조적, 기능적 약점
	- 재난 발생 시 피해를 얼마나 받을 것인가?
	- 건물 연식, 구조, 내진 설계, 소방시설 등

	9개 리스크:
	1. extreme_heat (극한 고온)
	2. extreme_cold (극한 한파)
	3. drought (가뭄)
	4. river_flood (하천 홍수)
	5. urban_flood (도시 홍수)
	6. sea_level_rise (해수면 상승)
	7. typhoon (태풍)
	8. wildfire (산불)
	9. water_stress (물부족)
	"""

	def __init__(self):
		"""
		VulnerabilityAnalysisAgent 초기화
		"""
		self.logger = logger
		self.logger.info("VulnerabilityAnalysisAgent 초기화 완료 (9개 리스크 지원)")

	def calculate_vulnerability(self, exposure: Dict[str, Any]) -> Dict[str, Any]:
		"""
		Exposure 데이터 → 9개 리스크별 Vulnerability 계산

		Args:
			exposure: Exposure 계산 결과 (building, flood_exposure 등 포함)

		Returns:
			Vulnerability 점수 딕셔너리 (각 리스크별 score, level, factors)
		"""
		self.logger.info("9개 리스크별 취약성 계산 시작")

		building = exposure['building']

		# 9개 리스크별 Vulnerability 계산
		vulnerability = {
			'extreme_heat': self._calculate_heat_vulnerability(exposure),
			'extreme_cold': self._calculate_cold_vulnerability(exposure),
			'drought': self._calculate_drought_vulnerability(exposure),
			'river_flood': self._calculate_inland_flood_vulnerability(exposure),
			'urban_flood': self._calculate_urban_flood_vulnerability(exposure),
			'sea_level_rise': self._calculate_coastal_flood_vulnerability(exposure),
			'typhoon': self._calculate_typhoon_vulnerability(exposure),
			'wildfire': self._calculate_wildfire_vulnerability(exposure),
			'water_stress': self._calculate_water_stress_vulnerability(exposure),
		}

		self.logger.info("취약성 계산 완료")
		return vulnerability

	# ========================================================================
	# 1. 극한 고온 (Extreme Heat) 취약성
	# ========================================================================

	def _calculate_heat_vulnerability(self, exposure: Dict) -> Dict:
		"""
		극한 고온 취약성
		- 냉방 시스템, 단열, 건물 연식, 노출된 외벽 면적 등
		"""
		building = exposure['building']
		age = building['building_age']
		structure = building['structure']

		# 취약성 점수 계산 (0-100, 높을수록 취약)
		score = 50  # 기본값

		# 건물 연식 (오래될수록 취약)
		if age > 30:
			score += 20
		elif age > 20:
			score += 10

		# 구조 (단열 성능)
		if '목조' in structure or '벽돌' in structure:
			score += 15  # 단열 취약
		elif '철근콘크리트' in structure:
			score -= 10  # 단열 양호

		# 용도 (냉방 필요성)
		if building['main_purpose'] in ['업무시설', '상업시설']:
			score += 10  # 냉방 부하 높음

		# 0-100 범위로 정규화
		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'building_age': age,
				'insulation_quality': 'poor' if age > 30 else 'fair',
				'cooling_capacity': 'standard',
				'heat_resistance': 'medium',
			}
		}

	# ========================================================================
	# 2. 극한 한파 (Extreme Cold) 취약성
	# ========================================================================

	def _calculate_cold_vulnerability(self, exposure: Dict) -> Dict:
		"""극한 한파 취약성"""
		building = exposure['building']
		age = building['building_age']

		score = 50

		if age > 30:
			score += 20  # 노후 건물 → 단열 취약
		elif age > 20:
			score += 10

		if '목조' in building['structure']:
			score += 15  # 목조 → 한파 취약

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'building_age': age,
				'insulation_quality': 'poor' if age > 30 else 'fair',
				'heating_system': 'standard',
				'pipe_freeze_risk': 'medium',
			}
		}

	# ========================================================================
	# 3. 가뭄 (Drought) 취약성
	# ========================================================================

	def _calculate_drought_vulnerability(self, exposure: Dict) -> Dict:
		"""가뭄 취약성"""
		building = exposure['building']
		infra = exposure['infrastructure']

		score = 30  # 가뭄은 건물 직접 피해 적음

		# 용수 의존도
		if building['main_purpose'] in ['공장', '숙박시설']:
			score += 30  # 용수 의존도 높음

		# 비상 급수
		if not infra['water_supply_available']:
			score += 20

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'water_dependency': 'medium',
				'backup_water_supply': infra['water_supply_available'],
				'water_storage_capacity': 'limited',
			}
		}

	# ========================================================================
	# 4. 내륙 홍수 (Inland Flood) 취약성
	# ========================================================================

	def _calculate_inland_flood_vulnerability(self, exposure: Dict) -> Dict:
		"""
		내륙 홍수 취약성
		- 지하층, 필로티, 방수 설계, 배수 시설 등
		"""
		building = exposure['building']
		flood_exp = exposure['flood_exposure']

		score = 40  # 기본값

		# 지하층 (침수 시 큰 피해)
		if building['floors_below'] > 0:
			score += 25

		# 필로티 (침수 피해 감소)
		if building['has_piloti']:
			score -= 20

		# 건물 연식 (방수 성능 저하)
		if building['building_age'] > 30:
			score += 15

		# 홍수 위험 구역
		if flood_exp['in_flood_zone']:
			score += 20

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'has_basement': building['floors_below'] > 0,
				'has_piloti': building['has_piloti'],
				'waterproofing': 'poor' if building['building_age'] > 30 else 'fair',
				'drainage_system': 'standard',
				'flood_barrier': False,
			}
		}

	# ========================================================================
	# 5. 도시 홍수 (Urban Flood) 취약성
	# ========================================================================

	def _calculate_urban_flood_vulnerability(self, exposure: Dict) -> Dict:
		"""도시 홍수 취약성 (내륙 홍수와 유사)"""
		building = exposure['building']

		score = 40

		if building['floors_below'] > 0:
			score += 20

		if building['has_piloti']:
			score -= 15

		if building['building_age'] > 30:
			score += 10

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'has_basement': building['floors_below'] > 0,
				'has_piloti': building['has_piloti'],
				'drainage_connection': 'standard',
				'elevation_above_street': 0,
			}
		}

	# ========================================================================
	# 6. 해안 홍수 (Coastal Flood) 취약성
	# ========================================================================

	def _calculate_coastal_flood_vulnerability(self, exposure: Dict) -> Dict:
		"""해안 홍수 취약성"""
		typhoon_exp = exposure['typhoon_exposure']

		# 해안 멀리 떨어진 경우 취약성 낮음
		if not typhoon_exp['coastal_exposure']:
			return {
				'score': 0,
				'level': 'very_low',
				'factors': {
					'coastal_exposure': False,
					'storm_surge_protection': 'not_applicable',
				}
			}

		building = exposure['building']
		score = 50

		if building['floors_below'] > 0:
			score += 20

		if building['has_piloti']:
			score -= 15

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'coastal_exposure': True,
				'storm_surge_protection': 'none',
				'seawall_nearby': False,
			}
		}

	# ========================================================================
	# 7. 태풍 (Typhoon) 취약성
	# ========================================================================

	def _calculate_typhoon_vulnerability(self, exposure: Dict) -> Dict:
		"""
		태풍 취약성
		- 건물 구조, 층수, 외벽 상태, 유리창 면적 등
		"""
		building = exposure['building']
		age = building['building_age']

		score = 45

		# 구조 (내풍 성능)
		if '철근콘크리트' in building['structure'] or '철골' in building['structure']:
			score -= 15  # 강풍 저항 강함
		elif '목조' in building['structure'] or '벽돌' in building['structure']:
			score += 20  # 강풍 취약

		# 건물 연식
		if age > 30:
			score += 20  # 구조 노후 → 강풍 취약

		# 건물 높이 (고층 건물 → 강풍 노출)
		if building['floors_above'] > 10:
			score += 15

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'structural_strength': 'high' if '철근콘크리트' in building['structure'] else 'medium',
				'building_age': age,
				'window_area': 'medium',
				'roof_condition': 'fair',
				'wind_resistance_design': age < 20,  # 최근 건물은 내풍 설계
			}
		}

	# ========================================================================
	# 8. 산불 (Wildfire) 취약성
	# ========================================================================

	def _calculate_wildfire_vulnerability(self, exposure: Dict) -> Dict:
		"""산불 취약성"""
		building = exposure['building']
		wildfire_exp = exposure['wildfire_exposure']

		score = 30

		# 구조 (내화 성능)
		if '목조' in building['structure']:
			score += 30  # 목조 → 화재 취약
		elif '철근콘크리트' in building['structure']:
			score -= 10  # 내화 성능 양호

		# 산림 인접성
		if wildfire_exp['distance_to_forest_m'] < 500:
			score += 25

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'fire_resistant_materials': '목조' not in building['structure'],
				'defensible_space': wildfire_exp['distance_to_forest_m'] > 500,
				'roof_material': 'unknown',
				'fire_suppression_system': False,
			}
		}

	# ========================================================================
	# 9. 수자원 스트레스 (Water Stress) 취약성
	# ========================================================================

	def _calculate_water_stress_vulnerability(self, exposure: Dict) -> Dict:
		"""수자원 스트레스 취약성"""
		building = exposure['building']
		infra = exposure['infrastructure']

		score = 35

		# 용수 의존도
		if building['main_purpose'] in ['공장', '숙박시설', '업무시설']:
			score += 20

		# 비상 급수
		if not infra['water_supply_available']:
			score += 25

		score = max(0, min(100, score))

		return {
			'score': score,
			'level': self._score_to_level(score),
			'factors': {
				'water_dependency': 'high' if score > 60 else 'medium',
				'backup_supply': infra['water_supply_available'],
				'water_efficiency': 'standard',
			}
		}

	# ========================================================================
	# Helper Methods
	# ========================================================================

	def _score_to_level(self, score: float) -> str:
		"""점수 → 레벨 변환 (0-100 스케일)"""
		if score >= 80:
			return 'very_high'
		elif score >= 60:
			return 'high'
		elif score >= 40:
			return 'medium'
		elif score >= 20:
			return 'low'
		else:
			return 'very_low'
